{% extends "base.html" %}


{% block title %}Detalle del Grupo - Mi Aplicación{% endblock %}

{% block content %}
<script>
    const idGroup = "{{ id_group }}";
    const startingDate = {{ group_data.starting_date|default('')|tojson }};
    const endingDate = {{ group_data.ending_date|default('')|tojson }};
    const clientAges = {{ client_ages | tojson }};
    const current_table = "{{current_table}}";
</script>
<div class="container-fluid">
    <!-- Título del grupo -->
    <div class="row mt-1">
        <div class="col text-center">
            <h3 class="mt-1 mb-1">{{ group_data.id_group }}: {{ group_data.nombre_circuito }}</h3>
        </div>
    </div>

    <!-- Sección de información del grupo -->
    <div class="row mt-2">
        <!-- Primer bloque (izquierda) -->
        <div class="col-md-3">  
            <div class="card" style="background-color: #BDD8F1; border-radius: 10px;">
                <div class="card-body p-2">
                    <h5>Información General</h5>
                    <div class="row">
                        <!-- Columna izquierda (más ancha) -->
                        <div class="col-8">
                            <p><strong>ID Grupo:</strong> {{ group_data.id_group }}</p>
                            <p>
                                <strong>Guía:</strong> <span id="guideName">{{ group_data.guide_name or 'No asignado' }}</span>
                                <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editGuideModal">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </p>
                            <p>
                                <strong>Bus:</strong> <span id="busInfo">{{ group_data.bus_company or 'No asignado' }}{{ ' - ' + group_data.bus_code if group_data.bus_code else '' }}</span>
                                <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editBusModal">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </p>
                        </div>
                        <!-- Columna derecha (más estrecha) -->
                        <div class="col-4 d-flex justify-content-center">
                            <!-- Estado posicionado más arriba -->
                            <div class="align-self-start mt-2">
                                <span class="badge badge-pill badge-success" style="font-size: 1.2rem; padding: 10px;">{{ group_data.status | capitalize }}</span>
                                <p style="padding-top: 35%;">
                                    <strong>QR:</strong> <span id="qrStatus"> {{ 'Sí' if group_data.QR else 'No' }}</span>
                                    <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editQrModal">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal para Editar Guía -->
        <div class="modal fade" id="editGuideModal" tabindex="-1" aria-labelledby="editGuideModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="editGuideForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editGuideModalLabel">Editar Guía</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="guideSelect" class="form-label">Seleccione el nuevo guía</label>
                                <select class="form-select" id="guideSelect">
                                    <!-- Las opciones se generarán dinámicamente con JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal para Editar Bus -->
        <div class="modal fade" id="editBusModal" tabindex="-1" aria-labelledby="editBusModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="editBusForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editBusModalLabel">Editar Información del Bus</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="busCompanySelect" class="form-label">Seleccione la Compañía de Bus</label>
                                <select class="form-select" id="busCompanySelect" required>
                                    <!-- Las opciones se generarán dinámicamente con JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="busCodeInput" class="form-label">Código del Bus</label>
                                <input type="text" class="form-control" id="busCodeInput" value="" placeholder="Ingrese el código del bus" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal para Editar Estado del QR -->
        <div class="modal fade" id="editQrModal" tabindex="-1" aria-labelledby="editQrModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="editQrForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editQrModalLabel">Editar Estado del QR</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="qrSwitch" {{ 'checked' if group_data.has_qr else '' }}>
                                <label class="form-check-label" for="qrSwitch">QR Enviado</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        

        <!-- Segundo bloque (central, más ancho) -->
        <div class="col-md-5">
            <div class="card" style="background-color: #BDD8F1; border-radius: 10px;">
                <div class="card-body p-2">
                    <h5>Itinerario</h5>
                    <div class="row">
                        <div class="col">
                            <p><strong>Vuelo de Llegada:</strong> {{ group_data.start_flight or 'No asignado' }}</p>
                            <p><strong>Fecha de Inicio:</strong> <span id="fechaInicio">{{ group_data.start_date }}</span></p>
                            <p><strong>Ciudad Actual:</strong> {{ group_data.ciudad_actual or 'N/A' }}</p>
                        </div>
                        <div class="col">
                            <p><strong>Vuelo de Regreso:</strong> {{ group_data.end_flight or 'No asignado' }}</p>
                            <p><strong>Fecha de Regreso:</strong> <span id="fechaRegreso"> {{ group_data.end_date }}</span></p>
                            <p><strong>Hotel Actual:</strong> {{ group_data.hotel_actual or 'N/A' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tercer bloque (derecha, más estrecho) -->
        <div class="col-md-4">
            <div class="card" style="background-color: #BDD8F1; border-radius: 10px;">
                <div class="card-body p-2">
                    <div class="row">
                        <!-- Columna izquierda -->
                        <div class="col-6">
                            <h5>Contacto</h5>
                            <p>
                                <strong>Operaciones:</strong> <span id="operationsAgentInfo">{{ group_data.operaciones_name or 'No asignado' }}</span>
                                <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editOperationsAgentModal">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </p>
                            <p>
                                <strong>Asistente:</strong> <span id="assistantInfo">{{ group_data.nombre_asistente or 'No asignado' }}</span>
                                <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editAssistantModal">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </p>
                            <p>
                                <strong>Responsable de Hoteles:</strong> <span id="responsibleHotelsInfo"> {{ group_data.id_responsible_hotels or 'No asignado' }}</span>
                                <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editResponsibleHotelsModal">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </p>
                            
                        </div>
                        <!-- Columna derecha (Mapa) -->
                        <div class="col-6 d-flex align-items-start justify-content-center">
                            <!-- Mini mapa -->
                            <a href="#" data-bs-toggle="modal" data-bs-target="#mapModal">
                                <img src="{{ url_for('static', path='images/mini_mapa.png') }}" alt="Mapa" class="img-fluid mini-map-img" style="border-radius: 0px; max-width:90%">
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Editar Agente de Operaciones -->
    <div class="modal fade" id="editOperationsAgentModal" tabindex="-1" aria-labelledby="editOperationsAgentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editOperationsAgentForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editOperationsAgentModalLabel">Editar Agente de Operaciones</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="operationsAgentSelect" class="form-label">Seleccione el nuevo agente de operaciones</label>
                            <select class="form-select" id="operationsAgentSelect" required>
                                <!-- Las opciones se generarán dinámicamente con JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal para Editar Asistente -->
    <div class="modal fade" id="editAssistantModal" tabindex="-1" aria-labelledby="editAssistantModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editAssistantForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editAssistantModalLabel">Editar Asistente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="assistantSelect" class="form-label">Seleccione el nuevo asistente</label>
                            <select class="form-select" id="assistantSelect" required>
                                <!-- Las opciones se generarán dinámicamente con JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal para Editar Responsable de Hoteles -->
    <div class="modal fade" id="editResponsibleHotelsModal" tabindex="-1" aria-labelledby="editResponsibleHotelsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editResponsibleHotelsForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editResponsibleHotelsModalLabel">Editar Responsable de Hoteles</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="responsibleHotelsSelect" class="form-label">Seleccione el nuevo responsable de hoteles</label>
                            <select class="form-select" id="responsibleHotelsSelect" required>
                                <!-- Las opciones se generarán dinámicamente con JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para el mapa ampliado -->
    <div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true">
      <!-- Contenido del modal permanece igual -->
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="mapModalLabel">Ubicación del Grupo</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <!-- Mapa ampliado -->
            <div id="mapContainer" style="height: 500px;">
                <!-- Aquí irá el mapa interactivo -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Barra de pestañas -->
    <!-- Permanece igual -->
<!-- Barra de pestañas -->
<div class="d-flex justify-content-between align-items-baseline mt-3">
<ul class="nav nav-tabs mt-3" id="myTab" role="tablist">
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'clientes' %}active{% endif %}" href="/grupo/{{ id_group }}?table=clientes">Clientes</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'hoteles' %}active{% endif %}" href="/grupo/{{ id_group }}?table=hoteles">Hoteles</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'cuartos' %}active{% endif %}" href="/grupo/{{ id_group }}?table=cuartos">Cuartos</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'opcionales' %}active{% endif %}" href="/grupo/{{ id_group }}?table=opcionales">Opcionales</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'liquidacion' %}active{% endif %}" href="/grupo/{{ id_group }}?table=liquidacion">Liquidación</a>
    </li>
</ul>
 <!-- Botones a la derecha -->
 <div class="d-flex" style="bottom: 0%;">
    <!-- Botón de Filtro -->
    <button class="btn btn-custom me-2" type="button" data-bs-toggle="modal" data-bs-target="#filterModal">
        <i class="fas fa-filter"></i> Filtro
    </button>
    <!-- Botón de Exportar Datos -->
    <button type="button" class="btn btn-custom" id="exportButton" onclick="exportarDatos()">
        <i class="fas fa-file-export"></i> Exportar Datos
    </button>
</div>
</div>
<!-- Modal de Filtro -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Filtrar Opcionales</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">

                <!-- Fila 1: Pasajeros y Sexo -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label class="form-label">Pasajeros</label>
                        <div class="dropdown">
                            <button class="btn btn-custom dropdown-toggle w-100" type="button" id="passengerDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                                Seleccionar pasajeros
                            </button>
                            <div class="dropdown-menu p-2 w-100" style="max-height: 200px; overflow-y: auto;" id="passengerDropdownMenu" aria-labelledby="passengerDropdownButton">
                                <!-- Checkboxes de pasajeros -->
                            </div>
                        </div>
                        <small class="text-muted">Seleccione uno o varios pasajeros marcando las casillas.</small>
                    </div>
                    <div class="col-md-4">
                        <label for="filterSex" class="form-label">Sexo</label>
                        <select id="filterSex" class="form-select">
                            <option value="">Todos</option>
                            <option value="M">Masculino</option>
                            <option value="F">Femenino</option>
                            <option value="O">Otro</option>
                        </select>
                    </div>
                </div>

                <!-- Fila 2: Rango de Edad y Ciudades -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="filterMinAge" class="form-label">Edad Mínima</label>
                        <input type="number" class="form-control" id="filterMinAge" min="0">
                    </div>
                    <div class="col-md-4">
                        <label for="filterMaxAge" class="form-label">Edad Máxima</label>
                        <input type="number" class="form-control" id="filterMaxAge" min="0">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Ciudades</label>
                        <div class="dropdown">
                            <button class="btn btn-custom dropdown-toggle w-100" type="button" id="cityDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                                Seleccionar ciudades
                            </button>
                            <div class="dropdown-menu p-2 w-100" style="max-height: 200px; overflow-y: auto;" id="cityDropdownMenu" aria-labelledby="cityDropdownButton">
                                <!-- Checkboxes de ciudades -->
                            </div>
                        </div>
                        <small class="text-muted">Seleccione una o varias ciudades.</small>
                    </div>
                </div>

                <!-- Fila 3: Actividades -->
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">Actividades</label>
                        <div class="dropdown">
                            <button class="btn btn-custom dropdown-toggle w-100" type="button" id="activityDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                                Seleccionar actividades
                            </button>
                            <div class="dropdown-menu p-2 w-100" style="max-height: 200px; overflow-y: auto;" id="activityDropdownMenu" aria-labelledby="activityDropdownButton">
                                <!-- Checkboxes de actividades -->
                            </div>
                        </div>
                        <small class="text-muted">Seleccione una o varias actividades.</small>
                    </div>
                </div>
                
                <!-- Fila 4: Lugar de compra y Método de pago -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="filterPlaceOfPurchase" class="form-label">Lugar de compra</label>
                        <select id="filterPlaceOfPurchase" class="form-select">
                            <option value="">Todos</option>
                            <option value="before_trip">Antes del viaje</option>
                            <option value="during_trip">Durante el viaje</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="filterPaymentMethod" class="form-label">Método de pago</label>
                        <select id="filterPaymentMethod" class="form-select">
                            <option value="">Todos</option>
                            <option value="credit_card">Tarjeta de crédito</option>
                            <option value="debit_card">Tarjeta de débito</option>
                            <option value="cash">Efectivo</option>
                        </select>
                    </div>
                </div>
            

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="applyFilterBtn">Aplicar Filtro</button>
            </div>
        </div>
    </div>
</div>

<!-- Contenido de las pestañas -->
<div class="mt-3">
    {% if current_table == 'clientes' %}
        <!-- Contenido de Clientes -->
        <h3 class="mt-3">Lista de Clientes</h3>
        <!-- Tabla de clientes con datos reales -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="thead-light">
                    <tr>
                        <th>Nombre</th>
                        <th>Pasaporte</th>
                        <th>Teléfono</th>
                        <th>Fecha de Nacimiento</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cliente in table_data %}
                    <tr>
                        <td>{{ cliente.first_name }} {{ cliente.second_name or '' }} {{ cliente.paternal_surname }} {{ cliente.mother_surname }}</td>
                        <td>{{ cliente.passport or 'N/A' }}</td>
                        <td>{{ cliente.phone or 'N/A' }}</td>
                        <td>{{ cliente.birth_date or 'N/A' }}</td>
                        <td>{{ cliente.mail or 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% elif current_table == 'hoteles' %}
        <!-- Contenido de Hoteles -->
        <h3 class="mt-3">Lista de Hoteles</h3>
        <!-- Aquí iría el código para mostrar la tabla de hoteles con datos reales -->
        <!-- Ejemplo de tabla vacía -->
        <p>Contenido de hoteles no implementado aún.</p>
    {% elif current_table == 'cuartos' %}
        <!-- Contenido de Cuartos -->
        <h3 class="mt-3">Lista de Cuartos</h3>
        <!-- Aquí iría el código para mostrar la tabla de cuartos con datos reales -->
        <!-- Ejemplo de tabla vacía -->
        <p>Contenido de cuartos no implementado aún.</p>
    {% elif current_table == 'opcionales' %}
        <!-- Contenido de Opcionales -->
        <h3 class="mt-3">Lista de Opcionales</h3>
        {% if table_data %}
            {% set ns = namespace(cities=[]) %}
            {% set global_ns = namespace(total_global=0) %}
            {% for client in table_data %}
                {% set client_index = loop.index0 %}
                {% if client.day_optionals %}
                    {% for city, optionals_list in client.day_optionals.items() %}
                        {% if city != 'null' and optionals_list and city not in ns.cities %}
                            {% set ns.cities = ns.cities + [city] %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}

            {% if table_data %}
                <!-- Código para renderizar la tabla -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <!-- Encabezados -->
                        <thead class="thead-custom">
                            <tr>
                                <th class="thead-custom" style="background-color: #BDD8F1 !important;">Nombre Completo</th>
                                <th class="thead-custom" style="background-color: #BDD8F1 !important;">Edad</th>
                                <th class="thead-custom" style="background-color: #BDD8F1 !important;">Sexo</th>
                                {% set total_days = 0 %}
                                {% for city_info in itinerary %}
                                    {% set total_days = total_days + (city_info.days|length) %}
                                    {% for day in city_info.days %}
                                        {% set date_obj = day.date_obj %}
                                        {% if date_obj == current_date %}
                                            {% set current_day_class = 'current-city' %}
                                        {% elif date_obj < current_date %}
                                            {% set current_day_class = 'past-city' %}
                                        {% else %}
                                            {% set current_day_class = '' %}
                                        {% endif %}
                                        <th class="{{ current_day_class }}" style="background-color: #BDD8F1 !important;">
                                            {{ city_info.city }}<br>
                                            <small style="font-weight: lighter;">
                                                {{ day.date }}
                                            </small>
                                        </th>
                                    {% endfor %}
                                {% endfor %}
                                <th class="thead-custom" style="background-color: #BDD8F1 !important;">Total Opcionales</th>
                            </tr>
                        </thead>
                        <!-- Cuerpo -->
                        <tbody>
                            {% for client in table_data %}
                                {% set client_index = loop.index0 %}
                                {% set client_ns = namespace(total_cliente=0) %}
                                <tr data-bs-toggle="collapse" data-bs-target=".details-{{ client_index }}" aria-expanded="false" class="clickable">
                                    <!-- Nombre Completo -->
                                    <td>
                                        {{ client.first_name }} {{ client.second_name or '' }} {{ client.paternal_surname }} {{ client.mother_surname }}
                                        <!-- Icono para indicar que es expandible -->
                                        <span class="collapse-icon"><i class="fas fa-chevron-down"></i></span>
                                    </td>
                                    <!-- Edad -->
                                    <td>{{ client.age }}</td>
                                    <!-- Sexo -->
                                    <td>{{ client.sex }}</td>
                                    <!-- Opcionales por día -->
                                    {% for city_info in itinerary %}
                                        {% for day in city_info.days %}
                                            {% set date_obj = day.date_obj %}
                                            {% if date_obj == current_date %}
                                                {% set current_day_class = 'current-city' %}
                                            {% elif date_obj < current_date %}
                                                {% set current_day_class = 'past-city' %}
                                            {% else %}
                                                {% set current_day_class = '' %}
                                            {% endif %}
                                            <td class="{{ current_day_class }}">
                                                {% set day_id = day.id %}
                                                {% if client.day_optionals and day_id|string in client.day_optionals %}
                                                    {% set optionals_list = client.day_optionals[day_id|string] %}
                                                    <!-- Contenido contraído (visible por defecto) -->
                                                    <div class="contracted-content">
                                                        {% for optional in optionals_list %}
                                                            <p class="activity-name"><strong>{{ optional.optional_name }}</strong></p>
                                                            {% if optional.total %}
                                                                {% set client_ns.total_cliente = client_ns.total_cliente + optional.total %}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                    <!-- Contenido expandido (oculto por defecto) -->
                                                    <div class="collapse details-{{ client_index }}">
                                                        {% for optional in optionals_list %}
                                                            <p><strong>{{ optional.optional_name }}</strong></p>
                                                            
                                                            {% set place_abbrev = 'BT' if optional.place_of_purchase == 'before_trip' else 'OT' %}
                                                            {% set payment_abbrev = 
                                                                'CC' if optional.payment_method == 'credit_card' 
                                                                else 'DC' if optional.payment_method == 'debit_card' 
                                                                else '$' if optional.payment_method == 'Cash' 
                                                                else optional.payment_method 
                                                            %}
                                                            {% if optional.purchase_date %}
                                                                {% set pdate = optional.purchase_date[:10].split('-') %}
                                                                <!--{% set pdate_str = pdate[2] ~ '/' ~ pdate[1] ~ '/' ~ pdate[0] %}-->
                                                                {% set pdate_str = pdate[1] ~ '/' ~ pdate[0] %}
                                                            {% else %}
                                                                {% set pdate_str = '' %}
                                                            {% endif %}
                                                            
                                                            <!-- Nueva línea debajo del nombre -->
                                                            <p style="font-style: italic; font-size: small;">{{ place_abbrev }}-{{ pdate_str }}-{{ payment_abbrev }}</p>

                                                            <p>Precio: {{ optional.price }}</p>
                                                            <p>Descuento: {{ optional.discount or 0 }}</p>
                                                            <p>Total: {{ optional.total }}</p>
                                                            <a href="#" class="btn btn-sm btn-primary edit-optional"
                                                                data-client-id="{{ client.id_clients }}"
                                                                data-day-id="{{ day_id }}"
                                                                data-client-name="{{ client.first_name }} {{ client.paternal_surname }}"
                                                                data-city="{{ city_info.city }}"
                                                                data-group-id="{{ id_group }}"
                                                                data-city-days='{{ city_info.days_serializable | tojson }}'>Editar</a>
                                                            <hr>
                                                        {% endfor %}
                                                    </div>
                                                {% else %}
                                                    <!-- Contenido contraído (visible por defecto) -->
                                                    <div class="contracted-content">
                                                        <p>Sin opcionales</p>
                                                    </div>
                                                    <!-- Contenido expandido (oculto por defecto) -->
                                                    <div class="collapse details-{{ client_index }}">
                                                        <a href="#" class="btn btn-sm btn-success add-optional"
                                                           data-client-id="{{ client.id_clients }}"
                                                           data-client-name="{{ client.first_name }} {{ client.second_name or '' }} {{ client.paternal_surname }}"
                                                           data-group-id="{{ id_group }}"
                                                           data-city="{{ city_info.city }}"
                                                           data-city-days='{{ city_info.days_serializable | tojson }}'>Agregar</a>
                                                    </div>
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                    {% endfor %}
                                    <!-- Total Opcionales -->
                                    <td>{{ client_ns.total_cliente | round(2) }} €</td>
                                </tr>
                                {% set global_ns.total_global = global_ns.total_global + client_ns.total_cliente %}
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <!-- 3 columnas fijas: Nombre, Edad, Sexo -->
                                <!-- total_days columnas de días -->
                                <!-- 1 columna para Total Opcionales -->
                                <td colspan="{{ 3 + total_days + 1 }}" style="text-align: right; font-weight: bold;">
                                    Total General: {{ global_ns.total_global | round(2) }} €
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                        
                        <!-- Modal para agregar opcionales -->
                        <div class="modal fade" id="addOptionalModal" tabindex="-1" aria-labelledby="addOptionalModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">{{ modal_title }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Contenido del modal -->
                                        <form id="addOptionalForm">
                                            <input type="hidden" name="client_id" id="modalClientId">
                                            <input type="hidden" name="id_group" id="modalGroupId">
                                            <input type="hidden" name="id_days" id="modalDayId"> 
                                            <!-- Contenedor para los botones de días -->
                                            <div id="dayButtons" class="btn-group mb-3" role="group" aria-label="Días disponibles">
                                                <!-- Los botones se generan dinámicamente -->
                                            </div>
                                            <!-- Opcionales disponibles -->
                                            <h5 class="mt-3">Actividades Opcionales</h5>
                                            <hr>
                                            <div id="optionalList" class="mb-4">
                                                <!-- Opcionales se cargarán dinámicamente -->
                                            </div>
                                            <!-- Campos adicionales -->
                                            <div id="optionalDetails" style="display: none;">
                                                <h5>Detalles de la Actividad</h5>
                                                <hr>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="priceInput" class="form-label">Precio</label>
                                                            <input type="number" class="form-control" id="priceInput" name="price" step="1" min="0">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="discountInput" class="form-label">Descuento (%)</label>
                                                            <div class="d-flex align-items-center">
                                                                <input type="range" class="form-range" id="discountInput" name="discount" min="0" max="100" value="0" style="background-color: lightgray;">
                                                                <span id="discountValue" style="margin-left: 10px;">0%</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Resto de los campos -->
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="placeOfPurchase" class="form-label">Lugar de compra</label>
                                                            <select class="form-select" id="placeOfPurchase" name="place_of_purchase">
                                                                <option value="before_trip">Antes del viaje</option>
                                                                <option value="during_trip">Durante el viaje</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="paymentMethod" class="form-label">Método de pago</label>
                                                            <select class="form-select" id="paymentMethod" name="payment_method">
                                                                <option value="credit_card">Tarjeta de crédito</option>
                                                                <option value="debit_card">Tarjeta de débito</option>
                                                                <option value="cash">Efectivo</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="totalDisplay" class="form-label">Total</label>
                                                    <input type="text" class="form-control" id="totalDisplay" readonly>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="button" class="btn btn-primary" id="saveOptionalBtn">Guardar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Modal de opciones para editar opcionales -->
                        <div class="modal fade" id="optionModal" tabindex="-1" aria-labelledby="optionModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="optionModalLabel">Seleccione una acción</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p>¿Qué desea hacer con los opcionales de este cliente?</p>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-success" id="optionAdd">Agregar</button>
                                            <button type="button" class="btn btn-primary" id="optionEdit">Editar</button>
                                            <button type="button" class="btn btn-danger" id="optionDelete">Borrar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Modal para editar opcionales -->
                        <div class="modal fade" id="editOptionalModal" tabindex="-1" aria-labelledby="editOptionalModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Editar opcionales</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="editOptionalForm">
                                            <input type="hidden" name="client_id" id="editClientId">
                                            <input type="hidden" name="id_group" id="editGroupId">
                                            <input type="hidden" name="id_days" id="editDayId">
                        
                                            <!-- Botones de días -->
                                            <div id="editDayButtons" class="btn-group mb-3" role="group" aria-label="Días disponibles"></div>
                        
                                            <h5 class="mt-3">Opcionales del Cliente</h5>
                                            <hr>
                                            <div id="editOptionalList" class="mb-4">
                                                <!-- Aquí se cargarán las tarjetas de los opcionales existentes -->
                                            </div>
                        
                                            <!-- Nota: A diferencia de agregar, en editar cada opcional se mostrará como una tarjeta
                                                 con sus campos predefinidos y editables. El total se recalcula con price/discount.
                                                 No ocultamos el "optionalDetails" porque en edición cada opcional tendrá su propio mini-form.
                                                 Aquí no habrá un único "optionalDetails" general, sino uno por cada opcional existente. -->
                        
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="button" class="btn btn-primary" id="saveEditOptionalBtn">Guardar Cambios</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Modal para el flujo de borrado de opcionales -->
                        <div class="modal fade" id="deleteOptionalFlowModal" tabindex="-1" aria-labelledby="deleteOptionalFlowModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Borrar opcionales</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <input type="hidden" id="deleteClientId">
                                        <input type="hidden" id="deleteGroupId">
                                        <input type="hidden" id="deleteDayId">
                                        <input type="hidden" id="deleteSelectedOptionalId">
                                        <input type="hidden" id="deleteSelectedOptionalName">
                                        <input type="hidden" id="deleteSelectedActivityId">

                                        <!-- Botones de días -->
                                        <div id="deleteDayButtons" class="btn-group mb-3" role="group" aria-label="Días disponibles"></div>

                                        <h5 class="mt-3">Opcionales Asignadas al Cliente</h5>
                                        <hr>
                                        <div id="deleteOptionalList" class="mb-4">
                                            <!-- Aquí se cargarán las tarjetas de los opcionales existentes con un radio para seleccionar -->
                                        </div>

                                        <!-- Botón Borrar (inicialmente deshabilitado, se habilitará al seleccionar una opcional) -->
                                        <button type="button" class="btn btn-danger" id="proceedDeleteBtn" disabled>Borrar</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal de confirmación de borrado -->
                        <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Confirmar Borrado</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <p>Para borrar la actividad <strong id="toDeleteOptionalNameDisplay"></strong>, escriba:</p>
                                        <p class="text-muted">borrar <span id="toDeleteOptionalNameCode" style="font-weight:bold;"></span></p>
                                        <input type="text" class="form-control" id="deleteConfirmInput" placeholder="Escribir aquí...">
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <button type="button" class="btn btn-danger" id="confirmDeleteFinalBtn" disabled>Confirmar</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No hay actividades opcionales registradas para este grupo.</p>
            {% endif %}
        {% else %}
            <p>No hay datos disponibles para Opcionales.</p>
        {% endif %}
  
    
    {% elif current_table == 'liquidacion' %}
        <!-- Contenido de Liquidación -->
        <h3 class="mt-3">Liquidación</h3>
        <!-- Aquí iría el código para mostrar la liquidación con datos reales -->
        <!-- Ejemplo de contenido vacío -->
        <p>Contenido de liquidación no implementado aún.</p>
    {% else %}
        <p>Seleccione una pestaña para ver el contenido.</p>
    {% endif %}
</div>
<script src="{{ url_for('static', path='js/grupo_detalle.js') }}" defer></script>


<!-- Scripts para el mapa y modal (permanece igual) -->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>



{% endblock %}

