{% extends "base.html" %}


{% block title %}Detalle del Grupo - Mi Aplicación{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Título del grupo -->
    <div class="row mt-1">
        <div class="col text-center">
            <h3 class="mt-1 mb-1">{{ group_data.id_group }}: {{ group_data.nombre_circuito }}</h3>
        </div>
    </div>

    <!-- Sección de información del grupo -->
    <div class="row mt-2">
        <!-- Primer bloque (izquierda) -->
        <div class="col-md-3">
            <div class="card" style="background-color: #BDD8F1; border-radius: 10px;">
                <div class="card-body p-2">
                    <h5>Información General</h5>
                    <div class="row">
                        <!-- Columna izquierda (más ancha) -->
                        <div class="col-8">
                            <p><strong>ID Grupo:</strong> {{ group_data.id_group }}</p>
                            <p>
                                <strong>Guía:</strong> {{ group_data.guide_name or 'No asignado' }}
                                <a href="#" class="ml-2 edit-icon"><i class="fas fa-edit"></i></a>
                            </p>
                            <p>
                                <strong>Bus:</strong> {{ group_data.bus_company or 'No asignado' }}
                                <a href="#" class="ml-2 edit-icon"><i class="fas fa-edit"></i></a>
                            </p>
                        </div>
                        <!-- Columna derecha (más estrecha) -->
                        <div class="col-4 d-flex justify-content-center">
                            <!-- Estado posicionado más arriba -->
                            <div class="align-self-start mt-2">
                                <span class="badge badge-pill badge-success" style="font-size: 1.2rem; padding: 10px;">{{ group_data.status | capitalize }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Segundo bloque (central, más ancho) -->
        <div class="col-md-5">
            <div class="card" style="background-color: #BDD8F1; border-radius: 10px;">
                <div class="card-body p-2">
                    <h5>Itinerario</h5>
                    <div class="row">
                        <div class="col">
                            <p><strong>Vuelo de Llegada:</strong> {{ group_data.start_flight or 'No asignado' }}</p>
                            <p><strong>Fecha de Inicio:</strong> {{ group_data.start_date }}</p>
                            <p><strong>Ciudad Actual:</strong> {{ group_data.ciudad_actual or 'N/A' }}</p>
                        </div>
                        <div class="col">
                            <p><strong>Vuelo de Regreso:</strong> {{ group_data.end_flight or 'No asignado' }}</p>
                            <p><strong>Fecha de Regreso:</strong> {{ group_data.end_date }}</p>
                            <p><strong>Hotel Actual:</strong> {{ group_data.hotel_actual or 'N/A' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tercer bloque (derecha, más estrecho) -->
        <div class="col-md-4">
            <div class="card" style="background-color: #BDD8F1; border-radius: 10px;">
                <div class="card-body p-2">
                    <h5>Contacto</h5>
                    <div class="row">
                        <!-- Subdivisión lateral -->
                        <div class="col-6">
                            <p>
                                <strong>Operador:</strong> {{ group_data.operaciones_name or 'No asignado' }}
                                <a href="#" class="ml-2 edit-icon"><i class="fas fa-edit"></i></a>
                            </p>
                            <p>
                                <strong>Asistente:</strong> {{ group_data.nombre_asistente or 'No asignado' }}
                                <a href="#" class="ml-2 edit-icon"><i class="fas fa-edit"></i></a>
                            </p>
                            <p>
                                <strong>Hoteles:</strong> {{ group_data.id_responsible_hotels or 'No asignado' }}
                                <a href="#" class="ml-2 edit-icon"><i class="fas fa-edit"></i></a>
                            </p>
                            <p>
                                <strong>QR enviado:</strong> {{ 'Sí' if group_data.QR else 'No' }}
                                <a href="#" class="ml-2 edit-icon"><i class="fas fa-edit"></i></a>
                            </p>
                        </div>
                        <div class="col-6 d-flex align-items-center justify-content-center">
                            <!-- Mini mapa -->
                            <a href="#" data-toggle="modal" data-target="#mapModal">
                                <img src="{{ url_for('static', path='images/mini_mapa.png') }}" alt="Mapa" class="img-fluid" style="border-radius: 0px;">
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para el mapa ampliado -->
    <div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true">
      <!-- Contenido del modal permanece igual -->
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="mapModalLabel">Ubicación del Grupo</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Mapa ampliado -->
            <div id="mapContainer" style="height: 500px;">
                <!-- Aquí irá el mapa interactivo -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Barra de pestañas -->
    <!-- Permanece igual -->
<!-- Barra de pestañas -->
<ul class="nav nav-tabs mt-3" id="myTab" role="tablist">
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'clientes' %}active{% endif %}" href="/grupo/{{ id_group }}?table=clientes">Clientes</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'hoteles' %}active{% endif %}" href="/grupo/{{ id_group }}?table=hoteles">Hoteles</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'cuartos' %}active{% endif %}" href="/grupo/{{ id_group }}?table=cuartos">Cuartos</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'opcionales' %}active{% endif %}" href="/grupo/{{ id_group }}?table=opcionales">Opcionales</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'liquidacion' %}active{% endif %}" href="/grupo/{{ id_group }}?table=liquidacion">Liquidación</a>
    </li>
</ul>

<!-- Contenido de las pestañas -->
<!-- Contenido de las pestañas -->
<div class="mt-3">
    {% if current_table == 'clientes' %}
        <!-- Contenido de Clientes -->
        <h3 class="mt-3">Lista de Clientes</h3>
        <!-- Tabla de clientes con datos reales -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="thead-light">
                    <tr>
                        <th>Nombre</th>
                        <th>Pasaporte</th>
                        <th>Teléfono</th>
                        <th>Fecha de Nacimiento</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cliente in table_data %}
                    <tr>
                        <td>{{ cliente.first_name }} {{ cliente.second_name or '' }} {{ cliente.paternal_surname }} {{ cliente.mother_surname }}</td>
                        <td>{{ cliente.passport or 'N/A' }}</td>
                        <td>{{ cliente.phone or 'N/A' }}</td>
                        <td>{{ cliente.birth_date or 'N/A' }}</td>
                        <td>{{ cliente.mail or 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% elif current_table == 'hoteles' %}
        <!-- Contenido de Hoteles -->
        <h3 class="mt-3">Lista de Hoteles</h3>
        <!-- Aquí iría el código para mostrar la tabla de hoteles con datos reales -->
        <!-- Ejemplo de tabla vacía -->
        <p>Contenido de hoteles no implementado aún.</p>
    {% elif current_table == 'cuartos' %}
        <!-- Contenido de Cuartos -->
        <h3 class="mt-3">Lista de Cuartos</h3>
        <!-- Aquí iría el código para mostrar la tabla de cuartos con datos reales -->
        <!-- Ejemplo de tabla vacía -->
        <p>Contenido de cuartos no implementado aún.</p>
        {% elif current_table == 'opcionales' %}
        <!-- Contenido de Opcionales -->
        <h3 class="mt-3">Lista de Opcionales</h3>
        {% if table_data %}
            {% set ns = namespace(cities=[]) %}
            {% for client in table_data %}
                {% set client_index = loop.index0 %}
                {% if client.city_optionals %}
                    {% for city, optionals_list in client.city_optionals.items() %}
                        {% if city != 'null' and optionals_list and city not in ns.cities %}
                            {% set ns.cities = ns.cities + [city] %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}

            {% if ns.cities %}
                <!-- Código para renderizar la tabla -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <!-- Encabezados -->
                        <thead style="background-color: #BDD8F1;">
                            <tr>
                                <th>Nombre Completo</th>
                                <th>Fecha de Nacimiento</th>
                                <th>Sexo</th>
                                {% for city in ns.cities %}
                                    <th>{{ city }}</th>
                                {% endfor %}
                                <th>Total Opcionales</th>
                            </tr>
                        </thead>
                        <!-- Cuerpo -->
                        <tbody>
                            {% for client in table_data %}
                            {% set client_index = loop.index0 %}
                            {% set client_ns = namespace(total_cliente=0) %}
                            <tr data-toggle="collapse" data-target=".details-{{ client_index }}" aria-expanded="false" class="clickable">
                                <!-- Nombre Completo -->
                                <td>
                                    {{ client.first_name }} {{ client.second_name or '' }} {{ client.paternal_surname }} {{ client.mother_surname }}
                                    <!-- Icono para indicar que es expandible -->
                                    <span class="collapse-icon"><i class="fas fa-chevron-down"></i></span>
                                </td>
                                <!-- Fecha de Nacimiento -->
                                <td>{{ client.birth_date or 'N/A' }}</td>
                                <!-- Sexo -->
                                <td>{{ client.sex }}</td>
                                <!-- Opcionales por ciudad -->
                                {% for city in ns.cities %}
                                    <td>
                                        {% if client.city_optionals and city in client.city_optionals %}
                                            {% set optionals_list = client.city_optionals[city] %}
                                            {% if optionals_list %}
                                                <div class="contracted-content">
                                                    {% for optional in optionals_list %}
                                                        <p class="activity-name"><strong>{{ optional.optional_name }}</strong></p>
                                                        {% if optional.total %}
                                                            {% set client_ns.total_cliente = client_ns.total_cliente + optional.total %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                <div class="collapse details-{{ client_index }}">
                                                    {% for optional in optionals_list %}
                                                        <p><strong>{{ optional.optional_name }}</strong></p>
                                                        <p>Precio: {{ optional.price }}</p>
                                                        <p>Descuento: {{ optional.discount or 0 }}</p>
                                                        <p>Total: {{ optional.total }}</p>
                                                        <!-- Botón para editar -->
                                                        <a href="#" class="btn btn-sm btn-primary edit-optional" data-client-id="{{ client_index }}" data-city="{{ city }}">Editar</a>
                                                        <hr>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <!-- Sin opcionales -->
                                                <div class="contracted-content">
                                                    <p>Sin opcionales</p>
                                                </div>
                                                <div class="collapse details-{{ client_index }}">
                                                    <!-- Botón para agregar -->
                                                    <a href="#" class="btn btn-sm btn-success add-optional" data-client-id="{{ client_index }}" data-city="{{ city }}">Agregar</a>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <!-- Sin opcionales -->
                                            <div class="contracted-content">
                                                <p>Sin opcionales</p>
                                            </div>
                                            <div class="collapse details-{{ client_index }}">
                                                <!-- Botón para agregar -->
                                                <a href="#" class="btn btn-sm btn-success add-optional" data-client-id="{{ client_index }}" data-city="{{ city }}">Agregar</a>
                                            </div>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                                <!-- Total Opcionales -->
                                <td>{{ client_ns.total_cliente | round(2) }} €</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No hay actividades opcionales registradas para este grupo.</p>
            {% endif %}
        {% else %}
            <p>No hay datos disponibles para Opcionales.</p>
        {% endif %}
  
    
    {% elif current_table == 'liquidacion' %}
        <!-- Contenido de Liquidación -->
        <h3 class="mt-3">Liquidación</h3>
        <!-- Aquí iría el código para mostrar la liquidación con datos reales -->
        <!-- Ejemplo de contenido vacío -->
        <p>Contenido de liquidación no implementado aún.</p>
    {% else %}
        <p>Seleccione una pestaña para ver el contenido.</p>
    {% endif %}
</div>

<!-- Estilos -->
<style>
    .edit-icon {
        display: none;
        color: #007bff;
    }
    p:hover .edit-icon {
        display: inline;
    }
    /* Ajustar márgenes y padding */
    h3 {
        margin-top: 3px;
        margin-bottom: 3px;
    }
    .mb-1 {
    margin-bottom: .1px !important;
    margin-top: .1px !important;
    }
    /* Centrar el estado "Activo" */
    .badge {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    /* Hacer que las tarjetas tengan la misma altura */
    .card {
        height: 100%;
    }

    /* Estilos para hacer el encabezado de la tabla fijo */
    .table-responsive {
        max-height: 750px; /* Ajusta esta altura según tus necesidades */
        overflow-y: auto;
    }

    .table thead th {
        position: sticky;
        top: 0;
        background-color: #BDD8F1; /* Asegúrate de que coincida con el color de fondo del encabezado */
        z-index: 2; /* Asegura que el encabezado esté por encima del contenido */
    }

    /* Opcional: estilo para las sombras */
    .table thead th::after {
        content: '';
        position: absolute;
        left: 0;
        right: 0;
        bottom: -1px;
        height: 1px;
        background-color: #ddd;
    }

    /* Hacer que el cursor sea de puntero en filas clicables */
    .clickable {
        cursor: pointer;
    }
    .clickable:hover {
        background-color: #f5f5f5;
    }
    .collapse-icon {
        float: right;
        font-size: 0.9em;
        margin-top: 4px;
    }
    /* Estilos para separar los nombres de las actividades */
    .activity-name {
        margin: 0;
        padding: 0;
    }
    .activity-name:not(:last-child) {
        border-bottom: 1px solid #ddd;
        margin-bottom: 5px;
    }
    /* Estilos para el contenido oculto */
    .collapse {
        background-color: #f9f9f9;
    }
    /* Ajustar el padding en las celdas */
    td {
        vertical-align: top;
        padding: 8px;
    }

    /* Ocultar el contenido contraído cuando la fila está expandida */
    tr[aria-expanded="true"] .contracted-content {
        display: none;
    }

    /* Rotar el icono al expandir */
    tr.clickable .collapse-icon i {
        transition: transform 0.2s;
    }

    tr[aria-expanded="true"] .collapse-icon i {
        transform: rotate(180deg);
    }
</style>

<!-- Scripts para el mapa y modal (permanece igual) -->
<!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script> -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>
<!-- CSS de Bootstrap -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<!-- CSS de Font Awesome (para los íconos) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">




<script>
    // Inicializar el mapa cuando el modal se muestra
    var map; // Declaramos la variable map fuera de las funciones

    $(document).ready(function() {
        // Inicializar el mapa cuando el modal se muestra
        $('#mapModal').on('shown.bs.modal', function () {
            if (!map) {
                // Solo inicializamos el mapa si no existe
                map = L.map('mapContainer').setView([51.505, -0.09], 13); // Coordenadas de ejemplo

                // Añadir capa de mapa (OpenStreetMap)
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                // Añadir marcador (opcional)
                L.marker([51.505, -0.09]).addTo(map)
                    .bindPopup('Ubicación del grupo')
                    .openPopup();
            } else {
                // Si el mapa ya existe, solo actualizamos su tamaño
                map.invalidateSize();
            }
        });

        // Eliminar el mapa cuando el modal se cierra
        $('#mapModal').on('hidden.bs.modal', function () {
            if (map) {
                map.remove(); // Eliminar la instancia del mapa
                map = null;    // Reiniciar la variable map
            }
        });
    });
</script>
<script>
    $(document).ready(function(){
        $('tr.clickable').on('click', function(){
            var target = $(this).data('target');
            var $target = $(target);
            $target.collapse('toggle');
            var expanded = $(this).attr('aria-expanded') === 'true';
            $(this).attr('aria-expanded', !expanded);
        });
    
        // Evitar que el clic en los botones internos cierre la fila
        $(document).on('click', '.edit-optional, .add-optional', function(e) {
            e.stopPropagation();
        });
    });
    </script>
{% endblock %}

