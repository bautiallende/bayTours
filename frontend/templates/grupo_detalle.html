{% extends "base.html" %}


{% block title %}Detalle del Grupo - Mi Aplicación{% endblock %}

{% block content %}
<script>
    const idGroup = "{{ id_group }}";
    const startingDate = {{ starting_date|default('')|tojson }};
    const endingDate = {{ ending_date|default('')|tojson }};
</script>
<div class="container-fluid">
    <!-- Título del grupo -->
    <div class="row mt-1">
        <div class="col text-center">
            <h3 class="mt-1 mb-1">{{ group_data.id_group }}: {{ group_data.nombre_circuito }}</h3>
        </div>
    </div>

    <!-- Sección de información del grupo -->
    <div class="row mt-2">
        <!-- Primer bloque (izquierda) -->
        <div class="col-md-3">
            <div class="card" style="background-color: #BDD8F1; border-radius: 10px;">
                <div class="card-body p-2">
                    <h5>Información General</h5>
                    <div class="row">
                        <!-- Columna izquierda (más ancha) -->
                        <div class="col-8">
                            <p><strong>ID Grupo:</strong> {{ group_data.id_group }}</p>
                            <p>
                                <strong>Guía:</strong> <span id="guideName">{{ group_data.guide_name or 'No asignado' }}</span>
                                <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editGuideModal">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </p>
                            <p>
                                <strong>Bus:</strong> <span id="busInfo">{{ group_data.bus_company or 'No asignado' }}{{ ' - ' + group_data.bus_code if group_data.bus_code else '' }}</span>
                                <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editBusModal">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </p>
                        </div>
                        <!-- Columna derecha (más estrecha) -->
                        <div class="col-4 d-flex justify-content-center">
                            <!-- Estado posicionado más arriba -->
                            <div class="align-self-start mt-2">
                                <span class="badge badge-pill badge-success" style="font-size: 1.2rem; padding: 10px;">{{ group_data.status | capitalize }}</span>
                                <p>
                                    <strong>QR:</strong> {{ 'Sí' if group_data.QR else 'No' }}
                                    <a href="#" class="ms-2 edit-icon"><i class="fas fa-edit"></i></a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal para Editar Guía -->
        <div class="modal fade" id="editGuideModal" tabindex="-1" aria-labelledby="editGuideModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="editGuideForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editGuideModalLabel">Editar Guía</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="guideSelect" class="form-label">Seleccione el nuevo guía</label>
                                <select class="form-select" id="guideSelect">
                                    <!-- Las opciones se generarán dinámicamente con JavaScript -->
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Modal para Editar Bus -->
        <div class="modal fade" id="editBusModal" tabindex="-1" aria-labelledby="editBusModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form id="editBusForm">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editBusModalLabel">Editar Información del Bus</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="busCompanySelect" class="form-label">Seleccione la Compañía de Bus</label>
                                <select class="form-select" id="busCompanySelect" required>
                                    <!-- Las opciones se generarán dinámicamente con JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="busCodeInput" class="form-label">Código del Bus</label>
                                <input type="text" class="form-control" id="busCodeInput" value="" placeholder="Ingrese el código del bus" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Segundo bloque (central, más ancho) -->
        <div class="col-md-5">
            <div class="card" style="background-color: #BDD8F1; border-radius: 10px;">
                <div class="card-body p-2">
                    <h5>Itinerario</h5>
                    <div class="row">
                        <div class="col">
                            <p><strong>Vuelo de Llegada:</strong> {{ group_data.start_flight or 'No asignado' }}</p>
                            <p><strong>Fecha de Inicio:</strong> {{ group_data.start_date }}</p>
                            <p><strong>Ciudad Actual:</strong> {{ group_data.ciudad_actual or 'N/A' }}</p>
                        </div>
                        <div class="col">
                            <p><strong>Vuelo de Regreso:</strong> {{ group_data.end_flight or 'No asignado' }}</p>
                            <p><strong>Fecha de Regreso:</strong> {{ group_data.end_date }}</p>
                            <p><strong>Hotel Actual:</strong> {{ group_data.hotel_actual or 'N/A' }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tercer bloque (derecha, más estrecho) -->
        <div class="col-md-4">
            <div class="card" style="background-color: #BDD8F1; border-radius: 10px;">
                <div class="card-body p-2">
                    <div class="row">
                        <!-- Columna izquierda -->
                        <div class="col-6">
                            <h5>Contacto</h5>
                            <p>
                                <strong>Operaciones:</strong> <span id="operationsAgentInfo">{{ group_data.operaciones_name or 'No asignado' }}</span>
                                <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editOperationsAgentModal">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </p>
                            <p>
                                <strong>Asistente:</strong> <span id="assistantInfo">{{ group_data.nombre_asistente or 'No asignado' }}</span>
                                <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editAssistantModal">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </p>
                            <p>
                                <strong>Responsable de Hoteles:</strong> <span id="responsibleHotelsInfo"> {{ group_data.id_responsible_hotels or 'No asignado' }}</span>
                                <a href="#" class="ms-2 edit-icon" data-bs-toggle="modal" data-bs-target="#editResponsibleHotelsModal">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </p>
                            
                        </div>
                        <!-- Columna derecha (Mapa) -->
                        <div class="col-6 d-flex align-items-start justify-content-center">
                            <!-- Mini mapa -->
                            <a href="#" data-bs-toggle="modal" data-bs-target="#mapModal">
                                <img src="{{ url_for('static', path='images/mini_mapa.png') }}" alt="Mapa" class="img-fluid mini-map-img" style="border-radius: 0px; max-width:90%">
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Editar Agente de Operaciones -->
    <div class="modal fade" id="editOperationsAgentModal" tabindex="-1" aria-labelledby="editOperationsAgentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editOperationsAgentForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editOperationsAgentModalLabel">Editar Agente de Operaciones</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="operationsAgentSelect" class="form-label">Seleccione el nuevo agente de operaciones</label>
                            <select class="form-select" id="operationsAgentSelect" required>
                                <!-- Las opciones se generarán dinámicamente con JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal para Editar Asistente -->
    <div class="modal fade" id="editAssistantModal" tabindex="-1" aria-labelledby="editAssistantModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editAssistantForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editAssistantModalLabel">Editar Asistente</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="assistantSelect" class="form-label">Seleccione el nuevo asistente</label>
                            <select class="form-select" id="assistantSelect" required>
                                <!-- Las opciones se generarán dinámicamente con JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Modal para Editar Responsable de Hoteles -->
    <div class="modal fade" id="editResponsibleHotelsModal" tabindex="-1" aria-labelledby="editResponsibleHotelsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editResponsibleHotelsForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editResponsibleHotelsModalLabel">Editar Responsable de Hoteles</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="responsibleHotelsSelect" class="form-label">Seleccione el nuevo responsable de hoteles</label>
                            <select class="form-select" id="responsibleHotelsSelect" required>
                                <!-- Las opciones se generarán dinámicamente con JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para el mapa ampliado -->
    <div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true">
      <!-- Contenido del modal permanece igual -->
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="mapModalLabel">Ubicación del Grupo</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <!-- Mapa ampliado -->
            <div id="mapContainer" style="height: 500px;">
                <!-- Aquí irá el mapa interactivo -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Barra de pestañas -->
    <!-- Permanece igual -->
<!-- Barra de pestañas -->
<ul class="nav nav-tabs mt-3" id="myTab" role="tablist">
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'clientes' %}active{% endif %}" href="/grupo/{{ id_group }}?table=clientes">Clientes</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'hoteles' %}active{% endif %}" href="/grupo/{{ id_group }}?table=hoteles">Hoteles</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'cuartos' %}active{% endif %}" href="/grupo/{{ id_group }}?table=cuartos">Cuartos</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'opcionales' %}active{% endif %}" href="/grupo/{{ id_group }}?table=opcionales">Opcionales</a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if current_table == 'liquidacion' %}active{% endif %}" href="/grupo/{{ id_group }}?table=liquidacion">Liquidación</a>
    </li>
</ul>

<!-- Contenido de las pestañas -->
<div class="mt-3">
    {% if current_table == 'clientes' %}
        <!-- Contenido de Clientes -->
        <h3 class="mt-3">Lista de Clientes</h3>
        <!-- Tabla de clientes con datos reales -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="thead-light">
                    <tr>
                        <th>Nombre</th>
                        <th>Pasaporte</th>
                        <th>Teléfono</th>
                        <th>Fecha de Nacimiento</th>
                        <th>Email</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cliente in table_data %}
                    <tr>
                        <td>{{ cliente.first_name }} {{ cliente.second_name or '' }} {{ cliente.paternal_surname }} {{ cliente.mother_surname }}</td>
                        <td>{{ cliente.passport or 'N/A' }}</td>
                        <td>{{ cliente.phone or 'N/A' }}</td>
                        <td>{{ cliente.birth_date or 'N/A' }}</td>
                        <td>{{ cliente.mail or 'N/A' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% elif current_table == 'hoteles' %}
        <!-- Contenido de Hoteles -->
        <h3 class="mt-3">Lista de Hoteles</h3>
        <!-- Aquí iría el código para mostrar la tabla de hoteles con datos reales -->
        <!-- Ejemplo de tabla vacía -->
        <p>Contenido de hoteles no implementado aún.</p>
    {% elif current_table == 'cuartos' %}
        <!-- Contenido de Cuartos -->
        <h3 class="mt-3">Lista de Cuartos</h3>
        <!-- Aquí iría el código para mostrar la tabla de cuartos con datos reales -->
        <!-- Ejemplo de tabla vacía -->
        <p>Contenido de cuartos no implementado aún.</p>
    {% elif current_table == 'opcionales' %}
        <!-- Contenido de Opcionales -->
        <h3 class="mt-3">Lista de Opcionales</h3>
        {% if table_data %}
            {% set ns = namespace(cities=[]) %}
            {% for client in table_data %}
                {% set client_index = loop.index0 %}
                {% if client.city_optionals %}
                    {% for city, optionals_list in client.city_optionals.items() %}
                        {% if city != 'null' and optionals_list and city not in ns.cities %}
                            {% set ns.cities = ns.cities + [city] %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}

            {% if ns.cities %}
                <!-- Código para renderizar la tabla -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <!-- Encabezados -->
                        <thead class="thead-custom">
                            <tr>
                                <th class="thead-custom" style="background-color: #BDD8F1 !important;">Nombre Completo</th>
                                <th class="thead-custom" style="background-color: #BDD8F1 !important;">Edad</th>
                                <th class="thead-custom" style="background-color: #BDD8F1 !important;">Sexo</th>
                                {% for city_info in itinerary %}
                                    {% set city = city_info.city %}
                                    {% if city_info.start_date_obj and city_info.end_date_obj %}
                                        {% if city_info.start_date_obj <= current_date <= city_info.end_date_obj %}
                                            {% set current_city_class = 'current-city' %}
                                        {% elif city_info.end_date_obj < current_date %}
                                            {% set current_city_class = 'past-city' %}
                                        {% else %}
                                            {% set current_city_class = '' %}
                                        {% endif %}
                                    {% else %}
                                        {% set current_city_class = '' %}
                                    {% endif %}
                                    <th class="{{ current_city_class }}" style="background-color: #BDD8F1 !important;">
                                        {{ city }}<br>
                                        <small style="font-weight: lighter;">
                                            {{ city_info.start_date }}<br>
                                            {{ city_info.end_date }}
                                        </small>
                                    </th>
                                {% endfor %}
                                <th class="thead-custom" style="background-color: #BDD8F1 !important;">Total Opcionales</th>
                            </tr>
                        </thead>
                        <!-- Cuerpo -->
                        <tbody>
                            {% for client in table_data %}
                            {% set client_index = loop.index0 %}
                            {% set client_ns = namespace(total_cliente=0) %}
                            <tr data-bs-toggle="collapse" data-bs-target="#details-{{ client_index }}" aria-expanded="false" class="clickable">
                                <!-- Nombre Completo -->
                                <td>
                                    {{ client.first_name }} {{ client.second_name or '' }} {{ client.paternal_surname }} {{ client.mother_surname }}
                                    <!-- Icono para indicar que es expandible -->
                                    <span class="collapse-icon"><i class="fas fa-chevron-down"></i></span>
                                </td>
                                <!-- Edad -->
                                <td>
                                    {{ client.age}}
                                </td>
                                <!-- Sexo -->
                                <td>{{ client.sex }}</td>
                                <!-- Opcionales por ciudad -->
                                {% for city_info in itinerary %}
                                    {% set city = city_info.city %}
                                    {% if city_info.start_date_obj and city_info.end_date_obj %}
                                        {% if city_info.start_date_obj <= current_date < city_info.end_date_obj %}
                                            {% set current_city_class = 'current-city' %}
                                        {% elif city_info.end_date_obj <= current_date %}
                                            {% set current_city_class = 'past-city' %}
                                        {% else %}
                                            {% set current_city_class = '' %}
                                        {% endif %}
                                    {% else %}
                                        {% set current_city_class = '' %}
                                    {% endif %}
                                    <td class="{{ current_city_class }}">
                                        {% if client.city_optionals and city in client.city_optionals %}
                                            {% set optionals_list = client.city_optionals[city] %}
                                            <div class="contracted-content">
                                                {% for optional in optionals_list %}
                                                    <p class="activity-name"><strong>{{ optional.optional_name }}</strong></p>
                                                    {% if optional.total %}
                                                        {% set client_ns.total_cliente = client_ns.total_cliente + optional.total %}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                            <div class="collapse" id="details-{{ client_index }}">
                                                {% for optional in optionals_list %}
                                                    <p><strong>{{ optional.optional_name }}</strong></p>
                                                    <p>Precio: {{ optional.price }}</p>
                                                    <p>Descuento: {{ optional.discount or 0 }}</p>
                                                    <p>Total: {{ optional.total }}</p>
                                                    <a href="#" class="btn btn-sm btn-primary edit-optional" data-client-id="{{ client_index }}" data-city="{{ city }}">Editar</a>
                                                    <hr>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <div class="contracted-content">
                                                <p>Sin opcionales</p>
                                            </div>
                                            <div class="collapse" id="details-{{ client_index }}">
                                                <a href="#" class="btn btn-sm btn-success add-optional" data-client-id="{{ client_index }}" data-city="{{ city }}">Agregar</a>
                                            </div>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                                <!-- Total Opcionales -->
                                <td>{{ client_ns.total_cliente | round(2) }} €</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>No hay actividades opcionales registradas para este grupo.</p>
            {% endif %}
        {% else %}
            <p>No hay datos disponibles para Opcionales.</p>
        {% endif %}
  
    
    {% elif current_table == 'liquidacion' %}
        <!-- Contenido de Liquidación -->
        <h3 class="mt-3">Liquidación</h3>
        <!-- Aquí iría el código para mostrar la liquidación con datos reales -->
        <!-- Ejemplo de contenido vacío -->
        <p>Contenido de liquidación no implementado aún.</p>
    {% else %}
        <p>Seleccione una pestaña para ver el contenido.</p>
    {% endif %}
</div>
<script src="{{ url_for('static', path='js/grupo_detalle.js') }}" defer></script>


<!-- Scripts para el mapa y modal (permanece igual) -->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" crossorigin=""></script>



{% endblock %}

